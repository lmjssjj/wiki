## 是否强制启动

```
device/mediatek/system/common/device.mk
#PRODUCT_PROPERTY_OVERRIDES += ro.control_privapp_permissions=log
device/mediatek/vendor/common/device.mk
PRODUCT_PROPERTY_OVERRIDES += ro.control_privapp_permissions=enforce
device/mediatek/common/device.mk
ro.control_privapp_permissions=enforce

```

## 流程

```java
//扫描priv-app  SCAN_AS_PRIVILEGED  SCAN_AS_SYSTEM
com.android.server.pm.PackageManagerService#PackageManagerService{
    // Collect privileged system packages.
    final File privilegedAppDir = new File(Environment.getRootDirectory(), "priv-app");
        scanDirTracedLI(privilegedAppDir,
                        mDefParseFlags
                        | PackageParser.PARSE_IS_SYSTEM_DIR,
                        scanFlags
                        | SCAN_AS_SYSTEM
                        | SCAN_AS_PRIVILEGED,
                        0);
    // Collect privileged vendor packages.
    File privilegedVendorAppDir = new File(Environment.getVendorDirectory(), "priv-app");
    try {
        privilegedVendorAppDir = privilegedVendorAppDir.getCanonicalFile();
    } catch (IOException e) {
        // failed to look up canonical path, continue with original one
    }
    scanDirTracedLI(privilegedVendorAppDir,
                    mDefParseFlags
                    | PackageParser.PARSE_IS_SYSTEM_DIR,
                    scanFlags
                    | SCAN_AS_SYSTEM
                    | SCAN_AS_VENDOR
                    | SCAN_AS_PRIVILEGED,
                    0);
    // Collect privileged odm packages. /odm is another vendor partition
    // other than /vendor.
    File privilegedOdmAppDir = new File(Environment.getOdmDirectory(),
                                        "priv-app");
    try {
        privilegedOdmAppDir = privilegedOdmAppDir.getCanonicalFile();
    } catch (IOException e) {
        // failed to look up canonical path, continue with original one
    }
    scanDirTracedLI(privilegedOdmAppDir,
                    mDefParseFlags
                    | PackageParser.PARSE_IS_SYSTEM_DIR,
                    scanFlags
                    | SCAN_AS_SYSTEM
                    | SCAN_AS_VENDOR
                    | SCAN_AS_PRIVILEGED,
                    0);
    // Collected privileged /product packages.
    File privilegedProductAppDir = new File(Environment.getProductDirectory(), "priv-app");
    try {
        privilegedProductAppDir = privilegedProductAppDir.getCanonicalFile();
    } catch (IOException e) {
        // failed to look up canonical path, continue with original one
    }
    scanDirTracedLI(privilegedProductAppDir,
                    mDefParseFlags
                    | PackageParser.PARSE_IS_SYSTEM_DIR,
                    scanFlags
                    | SCAN_AS_SYSTEM
                    | SCAN_AS_PRODUCT
                    | SCAN_AS_PRIVILEGED,
                    0);
    // Collected privileged /product_services packages.
    File privilegedProductServicesAppDir =
        new File(Environment.getProductServicesDirectory(), "priv-app");
    try {
        privilegedProductServicesAppDir =
            privilegedProductServicesAppDir.getCanonicalFile();
    } catch (IOException e) {
        // failed to look up canonical path, continue with original one
    }
    scanDirTracedLI(privilegedProductServicesAppDir,
                    mDefParseFlags
                    | PackageParser.PARSE_IS_SYSTEM_DIR,
                    scanFlags
                    | SCAN_AS_SYSTEM
                    | SCAN_AS_PRODUCT_SERVICES
                    | SCAN_AS_PRIVILEGED,
                    0);
}

//系统准备好时更新权限
com.android.server.pm.PackageManagerService#systemReady{
	mPermissionManager.updateAllPermissions(
                    StorageManager.UUID_PRIVATE_INTERNAL, false, mPackages.values(),
                    mPermissionCallback);
}
//代理
com.android.server.pm.permission.PermissionManagerService.PermissionManagerServiceInternalImpl#updateAllPermissions
//
com.android.server.pm.permission.PermissionManagerService#updatePermissions(){
    for (PackageParser.Package pkg : allPackages) {
        if (pkg != changingPkg) {
            // Only replace for packages on requested volume
            final String volumeUuid = getVolumeUuidForPackage(pkg);
            final boolean replace = ((flags & UPDATE_PERMISSIONS_REPLACE_ALL) != 0)
                && Objects.equals(replaceVolumeUuid, volumeUuid);
            restorePermissionState(pkg, replace, changingPkgName, callback);
        }
    }
}

com.android.server.pm.permission.PermissionManagerService#restorePermissionState{
    else if (bp.isSignature()) {
        // For all apps signature permissions are install time ones.
        allowedSig = grantSignaturePermission(perm, pkg, bp, origPermissions);
        if (allowedSig) {
            grant = GRANT_INSTALL;
        }
    }
}

com.android.server.pm.permission.PermissionManagerService#grantSignaturePermission{
    
    if (!hasPrivappWhitelistEntry(perm, pkg)) {
        //判断属性ro.control_privapp_permissions
   		//如果是enforce 将会执行下面
        if (RoSystemProperties.CONTROL_PRIVAPP_PERMISSIONS_ENFORCE) {
            if (mPrivappPermissionsViolations == null) {
                mPrivappPermissionsViolations = new ArraySet<>();
            }
             //如果没有在白名单添加就会添加到mPrivappPermissionsViolations集合里面
            mPrivappPermissionsViolations.add(pkg.packageName + ": " + perm);
        }
    }
}

//抛出异常开不了机
com.android.server.pm.permission.PermissionManagerService#systemReady{
    if (mPrivappPermissionsViolations != null) {
        throw new IllegalStateException("Signature|privileged permissions not in "
                                        + "privapp-permissions whitelist: " + 										mPrivappPermissionsViolations);
    }
}

//不在priv-app也是不给予权限
```

