```
frameworks/base/core/java/android/app/usage/UsageStatsManager.java
frameworks/base/services/usage/java/com/android/server/usage/UsageStatsService.java
frameworks/base/services/usage/java/com/android/server/usage/AppStandbyController.java
frameworks/base/services/usage/java/com/android/server/usage/UserUsageStatsService.java
frameworks/base/services/usage/java/com/android/server/usage/UsageStatsDatabase.java
```

## 记录时间事件

```java
//com.android.server.wm.ActivityRecord#setState
void setVisible(boolean newVisible) {       
    if (state == RESUMED) {
        mAtmService.updateActivityUsageStats(this, Event.ACTIVITY_RESUMED);
    } else if (state == PAUSED) {
        mAtmService.updateActivityUsageStats(this, Event.ACTIVITY_PAUSED);
    } else if (state == STOPPED) {
   		mAtmService.updateActivityUsageStats(this, Event.ACTIVITY_STOPPED);
    } else if (state == DESTROYED) {
    	mAtmService.updateActivityUsageStats(this, Event.ACTIVITY_DESTROYED);
    }
}
```

## AppUsageLimitObserver

```
android.app.usage.UsageStatsManager#registerAppUsageLimitObserver
```

## 挂起应用

```
//限制 挂起应用 弹框
com.android.internal.app.SuspendedAppActivity
```

```java
//在启动应用时会调用ActivityStartInterceptor>interceptSuspendedPackageIfNeeded
//来中断启动应用
com.android.server.wm.ActivityStarter#startActivity()//
//中断挂起应用
com.android.server.wm.ActivityStartInterceptor#interceptSuspendedPackageIfNeeded

ActivityStarter->startActivity(){
    mInterceptor.setStates(userId, realCallingPid, realCallingUid, startFlags, callingPackage);
            if (mInterceptor.intercept(intent, rInfo, aInfo, resolvedType, inTask, callingPid,
                    callingUid, checkedOptions)) {
                // activity start was intercepted, e.g. because the target user is currently in quiet
                // mode (turn off work) or the target application is suspended
                intent = mInterceptor.mIntent;
                rInfo = mInterceptor.mRInfo;
                aInfo = mInterceptor.mAInfo;
                resolvedType = mInterceptor.mResolvedType;
                inTask = mInterceptor.mInTask;
                callingPid = mInterceptor.mCallingPid;
                callingUid = mInterceptor.mCallingUid;
                checkedOptions = mInterceptor.mActivityOptions;
            }
}
```

