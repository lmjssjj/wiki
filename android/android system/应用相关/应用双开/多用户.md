## 1、创建与启动

```java
//frameworks/base/services/core/java/com/android/server/pm/UserManagerService.java
public void createOrStartCustomUser() {
        android.util.Log.v("lmjssjj", "createOrStartCustomUserd");
        final int userSize = mUsers.size();
        boolean isAlreadyCreate = false;
        for (int i = 0; i < userSize; i++){
            UserInfo ui = mUsers.valueAt(i).info;
            if (ui.name!=null&&ui.name.equals("lmjssjj")) {
                isAlreadyCreate = true;
                break;
            }
        }
        if (!isAlreadyCreate){
             String[] disallowedps = {
                    "com.mediatek.camera",
                    "com.nuumobile.nuuretailmode",
                    "com.android.deskclock",
                    "com.example.lxn.agingtestnew",
                    "com.mediatek.gnss.nonframeworklbs",
                    "com.verizon.remoteSimlock",
                    "com.android.documentsui",
                    "com.android.externalstorage",
                    "com.mediatek.autodialer",
                    "com.android.companiondevicemanager",
                    "com.android.contacts",
                    "com.android.launcher3",
                    "com.android.provision",
                    "com.android.statementservice",
                    "com.nuu.factorymode",
                    "com.android.calendar",
                    "com.debug.loggerui",
                    "com.mediatek.op07.dialer",
                    "com.android.settings",
                    "com.android.systemui",
                    "com.android.deskclock",
                    "com.android.phone",
                    "com.android.music",
                    "com.android.gallery3d",
                    "com.android.dialer",
                    "com.mediatek.emcamera"
            };
            UserInfo userInfo = createProfileForUser("lmjssjj", UserInfo.FLAG_MANAGED_PROFILE, UserHandle.USER_SYSTEM, disallowedps);
			android.util.Log.v("lmjssjj", "UserInfo:" + userInfo);
        }


        android.util.Log.v("lmjssjj", "userSize:" + userSize);
        for (int i = 0; i < userSize; i++) {
            UserInfo ui = mUsers.valueAt(i).info;
            android.util.Log.v("lmjssjj", "name:" + ui.name);
            if (ui.name!=null&&ui.name.equals("lmjssjj")) {
                android.util.Log.v("lmjssjj", "createOrStartCustomUser->startUserInBackground");
                try {
                    ActivityManager.getService().startUserInBackground(ui.id);
                } catch (Exception e) {
                    e.printStackTrace();

                }
                return;
            }

        }
    }
```

## 2、调用

```java
frameworks/base/services/core/java/com/android/server/am/UserController.java
    void createDoubleUser(){
        mInjector.getUserManager().createOrStartCustomUser();
    }
```

## 3、系统启动完成后

```java
frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
com.android.server.am.ActivityManagerService#finishBooting{
	mUserController.createDoubleUser();
}
```

