## Zygote启动

```
//system\core\rootdir\init.zygote64.rc
init进程启动Zygote
```



```java
//frameworks/base/core/java/com/android/internal/os/ZygoteInit.java
//ZygoteInit.main(String[])
main(){
    zygoteServer = new ZygoteServer(isPrimaryZygote);
    //启动systemserver进程
    if (startSystemServer) {
                Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer);

                // {@code r == null} in the parent (zygote) process, and {@code r != null} in the
                // child (system_server) process.
                if (r != null) {
                    r.run();
                    return;
                }
    }
    //开启循环在等待孵化请求
    caller = zygoteServer.runSelectLoop(abiList);
}
```

```java
//frameworks/base/core/java/com/android/internal/os/ZygoteServer.java    
ZygoteServer(boolean isPrimaryZygote) {
        mUsapPoolEventFD = Zygote.getUsapPoolEventFD();

        if (isPrimaryZygote) {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.PRIMARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_PRIMARY_SOCKET_NAME);
        } else {
            mZygoteSocket = Zygote.createManagedSocketFromInitSocket(Zygote.SECONDARY_SOCKET_NAME);
            mUsapPoolSocket =
                    Zygote.createManagedSocketFromInitSocket(
                            Zygote.USAP_POOL_SECONDARY_SOCKET_NAME);
        }

        fetchUsapPoolPolicyProps();

        mUsapPoolSupported = true;
    }
```



## ServiceManager 启动

### init进程解析init.rc文件

```c++
//system\core\init\init.cpp
LoadBootScripts->parser.ParseConfig("path");

//system\core\rootdir\init.rc
on init
    # Start logd before any other services run to ensure we capture all of their logs.
    start logd

    # Start essential services.
    start servicemanager
    start hwservicemanager
    start vndservicemanager
```

```c
//frameworks/native/cmds/servicemanager/service_manager.c
int main(int argc, char** argv)
{
    if (argc > 1) {
        driver = argv[1];
    } else {
        driver = "/dev/binder";
    }

    bs = binder_open(driver, 128*1024);//打开驱动
    if (binder_become_context_manager(bs)) {//设为守护进程
        ALOGE("cannot become context manager (%s)\n", strerror(errno));
        return -1;
    }
    binder_loop(bs, svcmgr_handler);//开启循环
}
```



## 进程启动

```
//frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java
ActivityManagerService->startProcessLocked->mProcessList.startProcessLocked()

//frameworks/base/services/core/java/com/android/server/am/ProcessList.java
startProcessLocked->
startProcessLocked->startProcessLocked->startProcessLocked->startProcess->

//frameworks/base/core/java/android/os/ZygoteProcess.java
Process.start
->startViaZygote->zygoteSendArgsAndGetResult

socket通信
->attemptZygoteSendArgsAndGetResult


//frameworks/base/core/java/com/android/internal/os/ZygoteServer.java
//socket连接等待孵化进程
runSelectLoop()->connection.processOneCommand(this);

//frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java
->handleChildProc()->childZygoteInit()->RuntimeInit.findStaticMain ->返回runable对象
new MethodAndArgsCaller(m, argv);这里面通过反射方式调用了 ActivityThread.main方法

//frameworks/base/core/java/com/android/internal/os/RuntimeInit.java


```

